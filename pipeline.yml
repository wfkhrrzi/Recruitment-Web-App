variables:
  service_connection: 'dssandbox-spn'
  resource_group: 'PTAZSG-DEV-DSP-RG'
  app_name: 'ptsg-5dspwb04'
  slot_name: 'dstats'

pool:
  vmImage: ubuntu-latest

## No code trigger (events )
trigger: 
  branches:
    include:
    - deploy_v1

## Pipeline steps
steps:
  - task: UsePythonVersion@0
    displayName: "Setting Python version"
    inputs:
      versionSpec: '3.9'
      architecture: 'x64'
      # addToPath: true

  # Step 1, Make a venv, activate, install requirements, run collectstatic
  - script: |
      cd recruitment
      python3.9 -m venv antvenv
      source antvenv/bin/activate
      python3.9 -m pip install --upgrade pip
      pip install -r requirements.txt
      echo "Dependencies installation completed"
      python3.9 manage.py collectstatic
      echo "Collectstatic completed"      
    workingDirectory: "$(System.DefaultWorkingDirectory)"
    displayName: "Install requirements"
    
  # - task: CopyFiles@2
  #   displayName: "Copy antvenv into recruitment"
  #   inputs:
  #     SourceFolder: '$(System.DefaultWorkingDirectory)'  # Root folder
  #     Contents: 'requirements.txt'  # File to copy
  #     TargetFolder: '$(System.DefaultWorkingDirectory)/recruitment'  # Destination subfolder


   # Step 2, create zip file be deployed
  - task: ArchiveFiles@2
    displayName: "Archive files"
    inputs:
      rootFolderOrFile: "$(System.DefaultWorkingDirectory)/recruitment"
      includeRootFolder: false
      archiveType: 'zip'
      archiveFile: '$(Build.ArtifactStagingDirectory)/recruitment$(Build.BuildId).zip'
      replaceExistingArchive: true

  - task: PublishBuildArtifacts@1
    inputs:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)/recruitment$(Build.BuildId).zip'
      artifactName: 'drop'
    displayName: 'Publish build artifacts'

  
  #Step 3, deploy zip package to azure app service
  - task: AzureRmWebAppDeployment@4
    inputs:
      ConnectionType: 'AzureRM'
      azureSubscription: $(service_connection)
      appType: 'webAppLinux'
      WebAppName: $(app_name)
      deployToSlotOrASE: true
      ResourceGroupName: $(resource_group)
      SlotName: $(slot_name)
      packageForLinux:  '$(Build.ArtifactStagingDirectory)/recruitment$(Build.BuildId).zip'
      # packageForLinux:  '$(Build.ArtifactStagingDirectory)/**/*.zip'
      RuntimeStack: 'PYTHON|3.9'
      DeploymentType: 'zipDeploy'
      StartUpCommand: "gunicorn --bind=0.0.0.0:8080 --timeout 600 recruitment.wsgi"
      # StartUpCommand: "python manage.py runserver"
      AppSettings: '-Port 8080 -RequestTimeout "10:20:00" -WEBSITE_TIME_ZONE "Singapore Standard Time" -WEBSITES_PORT 8080 -WEBSITES_ENABLE_APP_SERVICE_STORAGE true -SCM_DO_BUILD_DURING_DEPLOYMENT true -ENABLE_ORYX_BUILD true'
      # timeoutInMinutes: 60 # Set the timeout to 60 minutes
    # Post Deployment Action
      #ScriptType: 'Inline Script'
      #InlineScript: "cd . & ls -la"
